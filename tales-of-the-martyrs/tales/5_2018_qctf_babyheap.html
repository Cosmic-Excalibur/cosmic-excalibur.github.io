<!DOCTYPE html>
<html>
<head>
	<link rel='icon' type='image/x-icon' href="/favicon.ico"/>
	<link rel='stylesheet' type='text/css' href="/essence-of-the-elders/skeleton-of-giants.css"/>
	<link rel='stylesheet' href='/essence-of-the-elders/spirit-of-codes/prism.css'/>
	<!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:100,300,400,500,700,900"> -->
	<meta charset="UTF-8"/>
	<title>2018 QCTF babyheap</title>
</head>
<body>
	<div class="center">
		<h1>2018 QCTF babyheap</h1>
		<ul class="navi">
			<li><a href="javascript:history.back()" class="back" title="Back"></a></li>
			<li><a href="/" class="home" title="Homepage"></a></li>
			<li><a href="javascript:history.forward()" class="forward" title="Forward"></a></li>
		</ul>
		<br><br>
	</div>
	<div class="main">

<div class="center"><p><comment>Note: The author's limited expertise in current topic may result in unclear or potentially erroneous articulations.</comment></p></div><br><br>

<p>æœ¬æ–‡è®°å½•ä¸€ä¸ªç®€å•çš„å †åˆ©ç”¨é—®é¢˜ã€‚</p>
<p>é™„ä»¶ï¼š</p>
<ul>
	<li><a href="/tales-of-the-martyrs/tales/oracle-of-namagari/5/libc-2.23.so">ğŸ”—libc-2.23.so</a></li>
	<li><a href="/tales-of-the-martyrs/tales/oracle-of-namagari/5/timu">ğŸ”—timu</a></li>
</ul>

<br>

<ul class="section"><li>
Off by null
</li></ul>

<p>æœ¬é¢˜ä¸­é€šè¿‡é€‰é¡¹1åˆ›å»ºæ–°çš„ç¬”è®°ï¼Œé€šè¿‡é€‰é¡¹2åˆ é™¤ç¬”è®°ï¼Œé€‰é¡¹3æŸ¥çœ‹æ‰€æœ‰çš„ç¬”è®°ã€‚</p>

<p>ç„¶è€Œï¼Œåˆ›å»ºç¬”è®°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªnullå­—ç¬¦æº¢å‡ºè‡³ä¸‹ä¸€ä¸ªchunkä¸­ã€‚</p>

<p>åœ¨glibc 2.23ä¸­ï¼Œä¸€ä¸ªè¢«åˆ†é…çš„chunkå…·æœ‰å¦‚ä¸‹ç»“æ„ï¼š<comment>ï¼ˆmalloc.cï¼Œ1111~1122ï¼Œ1142~1153ï¼‰</comment></p>
<br>

<pre><code class='language-c'>struct malloc_chunk {

  INTERNAL_SIZE_T      prev_size;  /* Size of previous chunk (if free).  */
  INTERNAL_SIZE_T      size;       /* Size in bytes, including overhead. */

  struct malloc_chunk* fd;         /* double links -- used only if free. */
  struct malloc_chunk* bk;

  /* Only used for large blocks: pointer to next larger size.  */
  struct malloc_chunk* fd_nextsize; /* double links -- used only if free. */
  struct malloc_chunk* bk_nextsize;
};</code></pre>
<br>

<pre><code class='language-text'>    chunk-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of previous chunk, if allocated            | |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of chunk, in bytes                       |M|P|
      mem-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             User data starts here...                          .
            .                                                               .
            .             (malloc_usable_size() bytes)                      .
            .                                                               |
nextchunk-> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            |             Size of chunk                                     |
            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre>

<br>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥å°†ä¸‹ä¸€ä¸ªchunkä¸­çš„prev_inuseä½è¦†ç›–ä¸º0ã€‚</p>

<ul class="section"><li>
The fastbin attack
</li></ul>

<tag id="tag1"><comment>â†“(*)</comment></tag>
<p>glibc 2.23ä¸­ï¼Œè¢«åˆ†é…çš„chunkåœ¨è¢«é‡Šæ”¾æ—¶è‹¥å¤§å°åœ¨<code>MINSIZE</code>è‡³<code>get_max_fast()</code>ä¹‹é—´ï¼Œé‚£ä¹ˆè¯¥chunkä¼šè¿›å…¥åºå·ä¸º<code>fastbin_index(size)</code>çš„fastbinä¸­ï¼Œæ­¤å¤–ï¼Œå¦‚æœåœ¨ç¼–è¯‘æ—¶<code>TRIM_FASTBINS</code>è¢«å®šä¹‰ï¼Œé‚£ä¹ˆè¯¥chunkåœ¨ä¸‹ä¸€ä¸ªchunkæ˜¯top chunkæ—¶å°†ä¸ä¼šè¢«æ”¾åˆ°fastbinä¸­ã€‚<comment>ï¼ˆmalloc.cï¼Œ3886~3955ï¼‰</comment></p>
<tag><comment>â†‘(*)</comment></tag>


<p>ä¸Šè¿°ä¸­ç›¸å…³çš„æ•°å€¼é‡å®šä¹‰å¦‚ä¸‹ï¼ˆæœ‰åˆ æ”¹ï¼‰ï¼š<comment>ï¼ˆmalloc.cï¼‰</comment></p><br>

<pre><code class='language-c'>#define SIZE_SZ                (sizeof(size_t))
#define MALLOC_ALIGNMENT       (2 * SIZE_SZ)
#define MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)
#define DEFAULT_MXFAST         (64 * SIZE_SZ / 4)
#define get_max_fast() \
  ((DEFAULT_MXFAST + SIZE_SZ) & ~MALLOC_ALIGN_MASK)
#define fastbin_index(sz) \
  ((((unsigned int) (sz)) >> (SIZE_SZ == 8 ? 4 : 3)) - 2)
</code></pre>
<br>

<p>é‡Šæ”¾æ—¶è¢«æ”¾å…¥fastbinä¸­çš„chunkä¼šåœ¨æ¸…é™¤ä¸»ä½“æ•°æ®åç›´æ¥æ’å…¥è‡³å¯¹åº”fastbinçš„å•é“¾è¡¨ä¸­å¹¶æˆä¸ºæ–°çš„å•é“¾è¡¨å¤´ï¼ˆé“¾è¡¨å°¾ä¸ºNULLï¼‰ï¼Œè‹¥æ’å…¥æ—¶å‘ç°fastbinåŸæ¥çš„é“¾è¡¨å¤´å°±æ˜¯å½“å‰è¢«é‡Šæ”¾çš„chunkï¼Œåˆ™æŠ›å‡ºé”™è¯¯ã€‚<comment>ï¼ˆmalloc.cï¼Œ3929~3948ï¼‰</comment></p>
<p>æ­¤å¤–ï¼Œå¯¹äºåœ¨<a href="#tag1">(*)</a>ä¸­æ²¡æœ‰è¢«æ”¾å…¥fastbinçš„chunkï¼Œè‹¥è¯¥chunkç”±mmapåˆ†é…ï¼Œåˆ™é€šè¿‡munmapé‡Šæ”¾ï¼Œå¦åˆ™ï¼Œå°†ä¼šæ£€æŸ¥å¦‚ä¸‹å››ä¸ªæ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå¦‚å‡æ»¡è¶³åˆ™è¿›è¡Œåˆå¹¶ã€æ¸…é™¤inuseä½ç­‰æ­¥éª¤ï¼Œå¹¶åœ¨å¤„ç†å®Œæ¯•åè¿›å…¥unsorted binä¸­ï¼Œåä¹‹æŠ›å‡ºé”™è¯¯ã€‚<comment>ï¼ˆmalloc.cï¼Œ3961~4105ï¼‰</comment></p>
<ul>
	<li>è¯¥chunkä¸æ˜¯top chunkã€‚<comment>ï¼ˆmalloc.cï¼Œ3971~3975ï¼‰</comment></li>
	<li>å½“chunkçš„åœ°å€ä¹‹é—´æ— é—´éš™æ—¶ï¼Œè¯¥chunkæœªè¶…å‡ºtop chunkçš„è¾¹ç•Œã€‚<comment>ï¼ˆmalloc.cï¼Œ3977~3983ï¼‰</comment></li>
	<li>ä¸‹ä¸€ä¸ªchunkçš„PREV_INUSEä½ä¸º1ã€‚<comment>ï¼ˆmalloc.cï¼Œ3985~3989ï¼‰</comment></li>
	<li>ä¸‹ä¸€ä¸ªchunkè¿‡å°æˆ–è¿‡å¤§ã€‚<comment>ï¼ˆmalloc.cï¼Œ3991~3997ï¼‰</comment></li>
</ul>
<p>å¯¹äºä¸Šè¿°ä¸­ä¸åº”è¢«munmapé‡Šæ”¾çš„chunkï¼Œåœ¨åˆ¤æ–­å®Œä¸Šè¿°å››ä¸ªæ¡ä»¶åï¼Œæ¸…ç©ºè¯¥chunkä¸­çš„ä¸»ä½“æ•°æ®ï¼Œåˆ¤æ–­è¯¥chunkçš„PREV_INUSEä½æ˜¯å¦ä¸º0ï¼Œè‹¥æ˜¯ï¼Œåˆ™å¼€å§‹å‘ååˆå¹¶ï¼ˆconsolidate backwardï¼‰ï¼Œå³å°†ä¸Šä¸€ä¸ªchunk unlinkï¼ˆä¹Ÿå³ä»å…¶æ‰€åœ¨çš„åŒå‘é“¾è¡¨ä¸­ç§»é™¤ï¼‰åå°†å…¶ä¸å½“å‰chunkåˆå¹¶ã€‚å½“ä¸‹ä¸€ä¸ªchunkæ˜¯top chunkæ—¶ï¼Œå°†å½“å‰chunkä¸top chunkåˆå¹¶ï¼Œå°†å½“å‰chunkçš„PREV_INUSEä½ç½®1å¹¶æ£€æŸ¥åˆå¹¶åçš„chunkæ˜¯å¦æ˜¯ä¸€ä¸ªåˆæ³•çš„chunkï¼ˆè§é™„å½•1ï¼‰ï¼Œåä¹‹ï¼Œå¦‚æœä¸‹ä¸‹ä¸ªchunkçš„PREV_INUSEä½ä¸º0æ—¶ï¼Œåˆ™å¼€å§‹å‘å‰åˆå¹¶ï¼ˆconsolidate forwardï¼‰ï¼Œå³å°†ä¸‹ä¸€ä¸ªchunk unlinkåä¸å½“å‰chunkåˆå¹¶ï¼Œè€Œå½“ä¸‹ä¸‹ä¸ªchunkçš„PREV_INUSEä½ä¸º1æ—¶å°†ä¸‹ä¸€ä¸ªchunkçš„PREV_INUSEä½ç½®0ã€‚<comment>ï¼ˆmalloc.cï¼Œ3999~4018ï¼‰</comment></p>
<p>å¦‚æœå‘ç”Ÿåˆå¹¶ï¼Œåˆ™åˆå¹¶åçš„chunkå˜æˆä¸€ä¸ªæ–°çš„æ•´ä½“ï¼Œé™¤éä¸top chunkå‘ç”Ÿåˆå¹¶ï¼Œè¿™ä¸ªchunkæœ€åéƒ½åº”è¿›å…¥unsorted binä¸­ã€‚unsorted binæ˜¯ä¸€ä¸ªåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå®ƒä¸fastbinä¸åŒçš„ä¸€ç‚¹åœ¨äºè¿›å…¥åè€…ä¸­çš„chunkåœ¨è¢«é‡Šæ”¾æ—¶ä¸å¿…æ¸…é™¤ä¸‹ä¸€ä¸ªchunkçš„PREV_INUSEä½ï¼Œä¹Ÿä¸å¿…ä¸é™¤äº†top chunkä»¥å¤–å…¶ä»–çš„chunkåˆå¹¶ï¼Œæ­¤å¤–ï¼Œunsorted binä¸­çš„chunkä¼šåœ¨mallocæŒ‘é€‰chunkæ—¶è€Œéè‡ªèº«è¢«é‡Šæ”¾æ—¶è¢«é‡æ–°åˆ†ç±»ï¼Œä¹Ÿå³æ ¹æ®å¤§å°å†³å®šè¿›å…¥åˆ°small binæˆ–large binä¸­ï¼Œåœ¨è¿™é‡Œæš‚ä¸èµ˜è¿°ã€‚åœ¨è¯¥chunkè¿›å…¥unsorted binä¸­ä¹‹å‰ï¼Œç¨‹åºä¼šæ£€æŸ¥unsorted binä¸­â€œè¡¨å¤´â€ä¸â€œè¡¨å¤´â€åçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹é—´çš„è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œè‹¥è¿™ä¸¤è€…ï¼ˆæœ‰å¯èƒ½æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼‰ä¸èƒ½ç›¸äº’æŒ‡å‘ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ï¼Œå¦åˆ™å°†chunkæ’å…¥åˆ°è¿™ä¸¤è€…ä¹‹é—´ï¼Œæœ€åå°†è¯¥chunkçš„PREV_INUSEä½ç½®1å¹¶æ£€æŸ¥è¯¥chunkæ˜¯å¦æ˜¯ä¸€ä¸ªåˆæ³•çš„free chunkï¼ˆè§é™„å½•1ï¼‰ã€‚<comment>ï¼ˆmalloc.cï¼Œ4026~4047ï¼‰</comment></p>


<br><br>

<ul class="section"><li>
é™„å½•1.  åˆæ³•çš„chunkä¸free chunk
</li></ul>
<details>
<summary></summary>
<br>
<pre><code class='language-c'>static void
do_check_chunk (mstate av, mchunkptr p)
{
  unsigned long sz = chunksize (p);
  /* min and max possible addresses assuming contiguous allocation */
  char *max_address = (char *) (av->top) + chunksize (av->top);
  char *min_address = max_address - av->system_mem;

  if (!chunk_is_mmapped (p))
    {
      /* Has legal address ... */
      if (p != av->top)
        {
          if (contiguous (av))
            {
              assert (((char *) p) >= min_address);
              assert (((char *) p + sz) <= ((char *) (av->top)));
            }
        }
      else
        {
          /* top size is always at least MINSIZE */
          assert ((unsigned long) (sz) >= MINSIZE);
          /* top predecessor always marked inuse */
          assert (prev_inuse (p));
        }
    }
  else
    {
      /* address is outside main heap  */
      if (contiguous (av) && av->top != initial_top (av))
        {
          assert (((char *) p) < min_address || ((char *) p) >= max_address);
        }
      /* chunk is page-aligned */
      assert (((p->prev_size + sz) & (GLRO (dl_pagesize) - 1)) == 0);
      /* mem is aligned */
      assert (aligned_OK (chunk2mem (p)));
    }
}

/*
   Properties of free chunks
 */

static void
do_check_free_chunk (mstate av, mchunkptr p)
{
  INTERNAL_SIZE_T sz = p->size & ~(PREV_INUSE | NON_MAIN_ARENA);
  mchunkptr next = chunk_at_offset (p, sz);

  do_check_chunk (av, p);

  /* Chunk must claim to be free ... */
  assert (!inuse (p));
  assert (!chunk_is_mmapped (p));

  /* Unless a special marker, must have OK fields */
  if ((unsigned long) (sz) >= MINSIZE)
    {
      assert ((sz & MALLOC_ALIGN_MASK) == 0);
      assert (aligned_OK (chunk2mem (p)));
      /* ... matching footer field */
      assert (next->prev_size == sz);
      /* ... and is fully consolidated */
      assert (prev_inuse (p));
      assert (next == av->top || inuse (next));

      /* ... and has minimally sane links */
      assert (p->fd->bk == p);
      assert (p->bk->fd == p);
    }
  else /* markers are always of size SIZE_SZ */
    assert (sz == SIZE_SZ);
}</code></pre>
<br>
</details>



</div>
<br><br><br><br><br><br><br><br><br><br><br><br><p style="color:gray">Tags: <span style="color:blue"><b>#Pwn</b></span><span color="gray">, </span><span style="color:blue"><b>#BinaryExploitation</b></span><span color="gray">, </span><span style="color:blue"><b>#HeapExploitation</b></span><span color="gray">, </span><span style="color:blue"><b>#OffByNull</b></span></p>
                    <p><div class="time"></div><span style="color:gray">Time: </span><b>2024-07-13 14:58</b></p><br><br><br><br><br><br>
	<script type="text/javascript" src="/essence-of-the-elders/spirit-of-mathematics/MathJax.js?config=TeX-AMS_HTML" async></script>
	<script type="text/x-mathjax-config;executed=true">
        window.MathJax.Hub.Config({
            showProcessingMessages: false,
            messageStyle: "none",
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]],
                displayMath: [["$$", "$$"], ["\\[", "\\]"]],
                skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"]
            },
            "HTML-CSS": {
                availableFonts: ["STIX", "TeX"],
                showMathMenu: false
            },
			SVG: { linebreaks: {automatic: true } }
        });
        //window.MathJax.Hub.Queue(["Typeset", MathJax.Hub,document.getElementsByClassName("ck-content")]);
	</script>
	<script src="/essence-of-the-elders/spirit-of-codes/prism.js"></script>
</body>
</html>