<!DOCTYPE html>
<html>
<head>
	<link rel='icon' type='image/x-icon' href="/favicon.ico"/>
	<link rel='stylesheet' type='text/css' href="/essence-of-the-elders/skeleton-of-giants.css"/>
	<link rel='stylesheet' href='/essence-of-the-elders/spirit-of-codes/prism.css'/>
	<!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:100,300,400,500,700,900"> -->
	<meta charset="UTF-8"/>
	<title>2024 CrewCTF Write-ups</title>
</head>
<body>
	<div class="center">
		<h1>2024 CrewCTF Write-ups</h1>
		<ul class="navi">
			<li><a href="javascript:history.back()" class="noafter back" title="Back"></a></li>
			<li><a href="/" class="noafter home" title="Homepage"></a></li>
			<li><a href="javascript:history.forward()" class="noafter forward" title="Forward"></a></li>
		</ul>
		<br><br>
	</div>
	<div class="main">

<p>8.4ä¸‹åˆæ‰“çš„ï¼Œæ²¡çœ‹å‡ ä¸ªé¢˜ï¼Œä¸è¿‡æ„Ÿè§‰æŒºæœ‰æ„æ€çš„ğŸ˜ˆ</p>
<br>

<ul class="section">
<li>Crypto - Boring LCG</li>
</ul>

<p>é™„ä»¶ï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/boring-lcg.zip">boring-lcg.zip</a></li>
</ul>
<br>

<pre><code class="language-python">import os
from sage.all import *
set_random_seed(1337)
Fp = GF(6143872265871328074704442651454311068421530353607832481181)
a, b = Fp.random_element(), Fp.random_element()

flag = (os.getenv('flag') or 'crew{submit_this_if_desperate}').encode()
s = Fp.from_integer(int.from_bytes(flag[len('crew{'):-len('}')], 'big'))

out = []
for _ in range(12): out.extend(s:=a*s+b)
print([x>>57 for x in out])
# [50, 32, 83, 12, 49, 34, 81, 101, 46, 108, 106, 57, 105, 115, 102, 51, 67, 34, 124, 15, 125, 117, 51, 124, 38, 10, 30, 76, 125, 27, 89, 14, 50, 93, 88, 56]</code></pre><br>

<p>é¢˜ç›®æœ¬èº«éå¸¸çŸ­ï¼Œä½†æ˜¯æ¨æŸ¿å­ğŸ…æœ‰ç‚¹éº»çƒ¦ã€‚è¿™ä¸ªè¿‡ç¨‹ç›¸å½“äºå°†æ˜æ–‡\(\text{FlagğŸš©}\in\mathbb{F}_{p^3}\)ä¸Šåšäº†å¦‚ä¸‹æ“ä½œï¼š</p>
\[
	c_{i+1}=\text{LCG}(c_i)=a\cdot c_i+b\in\mathbb{F}_{p^3},\qquad c_0=\text{FlagğŸš©}\in\mathbb{F}_{p^3}
\]

<p>å„ç§å‚æ•°éƒ½æ˜¯ç”±æŸä¸ªå·²çŸ¥çš„éšæœºæ•°ç§å­ç”Ÿæˆçš„ï¼Œå› æ­¤æˆ‘ä»¬çŸ¥é“æ‰€æœ‰çš„å‚æ•°ï¼š</p>
<pre><code class="language-python">modulus = x^3 + 6741171702277637523*x^2 + 11441156621098138177*x + 18315300953692143458
a = 11096584571873777345*z3^2 + 10557248725682989278*z3 + 3979752675954023529
b = 10472345338873147245*z3^2 + 15508141526608210223*z3 + 15735705331444753146
p = 18315300953692143461</code></pre><br>

<p>æ­¤å¤–ï¼Œ</p>
\[
\begin{aligned}
\text{LCG}(c_{i0}+c_{i1}\alpha+c_{i2}\alpha^2)&=k_{i0}+k_{i1}\alpha+k_{i2}\alpha^2\\
&=c_{(i+1)0}+c_{(i+1)1}\alpha+c_{(i+1)2}\alpha^2\\
&\in\mathbb{F}_{p^3}
\end{aligned}
\]
<p>å…¶ä¸­ï¼Œ</p>
\[
\left\{\begin{aligned}
k_{i2}&=&a_2c_{i2}(m_2^2-m_1)-(a_2c_{i1}+a_1c_{i2})m_2+b_2\\
& &+(a_2c_{i0}+a_1c_{i1}+a_0c_{i2})\\
k_{i1}&=&a_2c_{i2}(m_1m_2-m_0)-(a_2c_{i1}+a_1c_{i2})m_1+b_1\\
& &+(a_0c_{i1}+a_1c_{i0})\\
k_{i0}&=&a_2c_{i2}m_0m_2-(a_2c_{i1}+a_1c_{i2})m_0+b_0\\
& &+a_0c_{i0}\\
\end{aligned}\right.
\]

<p>\(\alpha\)æ˜¯\(\mathbb{F}_{p^3}\)çš„æœ¬åŸç”Ÿæˆå…ƒï¼Œè€Œ\(m_0,m_1,m_2\)è¡¨ç¤º\(\mathbb{F}_{p^3}\)çš„æœ¬åŸå¤šé¡¹å¼çš„åˆ†é‡ã€‚</p>

<p>é¢˜ç›®ç»™äº†\(c_{ij}\)é«˜8æ¯”ç‰¹ä½çš„æ•°æ®ï¼Œä¹Ÿå³</p>
\[
	c_{ij}=\tilde{c}_{ij}\cdot 2^{57}+x_{ij},\qquad i=1,\cdots,12,\ j=0,1,2
\]

<p>æˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹çš„æ ¼ï¼š</p>
\[
	\newcommand{\bs}{\boldsymbol}
	\bs L=\begin{pmatrix}
		\beta\cdot\bs A_{(n+1)\times(n-3)} & \bs B_{n+1}\\
		\beta\cdot p\bs I_{n-3} & \bs O\\
	\end{pmatrix}_{(2n-2)\times(2n-2)}
\]

<p>å…¶ä¸­\(n=36\)ï¼Œ</p>
\[
	\bs B = \begin{pmatrix}
	1 &   &        &   &       \\
	  & 1 &        &   &       \\
	  &   & \ddots &   &       \\
	  &   &        & 1 &       \\
	  &   &        &   & \gamma \\
	\end{pmatrix}_{n+1}
	  
\]

<p>\(\beta,\gamma\)å‡ä¸ºè¾ƒå¤§çš„æ•°ï¼Œ\(\bs A\)ä¸­çš„å„é¡¹è§æœ¬èŠ‚ç»“å°¾çš„ä»£ç ã€‚äºæ˜¯ï¼Œ\(\bs L\)ä¸­å«æœ‰å¦‚ä¸‹çš„æ ¼ç‚¹ï¼š</p>
\[
	\begin{pmatrix}x_{10} & x_{11} & x_{12} & x_{20} & \cdots & x_{12,2} & 1 &\Bigg\vert & k_1 & \cdots & k_{n-3}\end{pmatrix}\cdot \bs A=\begin{pmatrix}\smash[b]{\underbrace{0\quad \cdots\quad 0}_{n-3}} & x_{10} & x_{11} & x_{12} & x_{20} & \cdots & x_{12,2} & \gamma \end{pmatrix}
\]

<p>\(x_{ij}\)çš„å¤§å°å¤§è‡´ä¸º\(2^{57}\)ï¼Œæ®æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡æ±‚è§£\(\bs L\)ä¸Šçš„CVPé—®é¢˜æ¥æ‰¾åˆ°å¾…æ±‚çš„\(x_{ij}\)ï¼Œæ±‚å‡ºæ‰€æœ‰çš„\(x_{ij}\)ä»¥åï¼Œå¯¹\(c_1=(\tilde{c}_{10}+\tilde{c}_{11}\alpha+\tilde{c}_{12}\alpha^2)\cdot 2^{57}+(x_{10}+x_{11}\alpha+x_{12}\alpha^2)\)åœ¨\(\mathbb{F}_{p^3}\)ä¸Šè¿›è¡Œ\(\text{LCG}\)çš„é€†å˜æ¢å³å¯å¾—åˆ°æ˜æ–‡ï¼š</p>
\[
\text{FlagğŸš©}=c_0=\text{LCG}^{-1}(c_1)=\frac{c_1-b}{a}\in\mathbb{F}_{p^3}
\]
<br>

<pre><code class="language-python">#sage

def kannan_cvp(mat, target, reduction=(lambda x: x.LLL()), weight=None):
    if weight is None:
        weight = max(target)
    L = block_matrix([[mat, 0], [-matrix(target), weight]])
    for row in reduction(L):
        if row[-1] < 0:
            row = -row
        if row[-1] == weight:
            return row[:-1] + target

set_random_seed(1337)
Fp = GF(6143872265871328074704442651454311068421530353607832481181)
a, b = Fp.random_element(), Fp.random_element()
p = 18315300953692143461
z3 = Fp.gen()

m0, m1, m2, _ = Fp.modulus()
a0, a1, a2 = a
b0, b1, b2 = b

c = [50, 32, 83, 12, 49, 34, 81, 101, 46, 108, 106, 57, 105, 115, 102, 51, 67, 34, 124, 15, 125, 117, 51, 124, 38, 10, 30, 76, 125, 27, 89, 14, 50, 93, 88, 56]
n = len(c)
A = matrix(ZZ, n + 1, n - 3)
shift = 57
for i in range(n//3 - 1):
    ci0 = c[i*3 + 0] << shift
    ci1 = c[i*3 + 1] << shift
    ci2 = c[i*3 + 2] << shift
    ci0_ = c[i*3 + 3] << shift
    ci1_ = c[i*3 + 4] << shift
    ci2_ = c[i*3 + 5] << shift
    row = i*3
    col = i*3 + 0
    A[row + 0, col] = a0
    A[row + 1, col] = -a2*m0
    A[row + 2, col] = -a1*m0 + a2*m0*m2
    A[row + 3, col] = -1
    A[-1, col] = a0*ci0 + b0 - (a2*ci1 + a1*ci2)*m0 + a2*ci2*m0*m2 - ci0_
    col = i*3 + 1
    A[row + 0, col] = a1
    A[row + 1, col] = a0 - a2*m1
    A[row + 2, col] = -a1*m1 + a2*(m1*m2-m0)
    A[row + 4, col] = -1
    A[-1, col] = a0*ci1 + a1*ci0 + b1 - (a2*ci1 + a1*ci2)*m1 + a2*ci2*(m1*m2-m0) - ci1_
    col = i*3 + 2
    A[row + 0, col] = a2
    A[row + 1, col] = a1 - a2*m2
    A[row + 2, col] = a0 - a1*m2 + a2*(m2**2-m1)
    A[row + 5, col] = -1
    A[-1, col] = (a2*ci0 + a1*ci1 + a0*ci2) + b2 - (a2*ci1 + a1*ci2)*m2 + a2*ci2*(m2**2-m1) - ci2_

A1 = block_matrix([[A, 1],[p, 0]])

beta = 2**100
gamma = 2**100
A1[A.dimensions()[0] - 1, -1] *= gamma
A1[:, :n-3] *= beta

A_ = A1.LLL()

f = lambda x: round(2**(x-1)+(2**x-2**(x-1))/2)
center = [0]*A.dimensions()[1] + [f(57) for i in range(A.dimensions()[0]-1)] + [beta]

v = kannan_cvp(A1, vector(center))
print(v)</code></pre>
<br>

<p>FlagğŸš©ï¼š</p>
<pre><code class="language-text" style="color: red">crew{n0rm4l_LCG_but_1_d1d_xxx}</code></pre>
<br>

<p>Proof of Conceptï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/sol_boring-lcg.sage">sol_boring-lcg.sage</a></li>
</ul>
<br><br>

<ul class="section"><li>
Crypto - Admin
</li></ul>

<p>é™„ä»¶ï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/admin.zip">admin.zip</a></li>
</ul>
<br>

<p>å…³é”®çš„éƒ¨åˆ†åœ¨è¿™é‡Œï¼š</p>
<pre><code class="language-python">cipher = AES.new(key, AES.MODE_GCM, nonce=iv)
curusername = b'not_admin_username_' + str(i).encode()
enc, tag = cipher.encrypt_and_digest(pad(curusername, blksize))
return (curusername.decode(), iv.hex(), enc.hex(), tag.hex())</code></pre>
<br>

<p>è¿™æ˜¯ä¸€ç§åä¸ºGalois/Counter Mode (GCM)çš„åˆ†ç»„å¯†ç æ“ä½œæ¨¡å¼ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<div class="center">
<img width="600" src="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/1.png" alt="GCM operation (Wikipedia)"></img>
<br><br>
<comment>GCM operation (Wikipedia)</comment>
</div>
<br>

<p>æ›´è¯¦ç»†çš„è§£é‡Šå‚è§NISTç»™çš„æ–‡æ¡£ï¼š</p>
<div class="center">
<a underlined href="https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38d.pdf">Recommendation for Block Cipher Modes of Operation: Galois/Counter Mode (GCM) and GMAC</a>
</div>

<p>è€Œ<code>cipher.encrypt_and_digest</code>æ˜¯ä¸€ç§è®¤è¯åŠ å¯†çš„æ“ä½œï¼ˆauthenticated encryptionï¼‰ï¼Œè¿”å›çš„æ•°æ®åŒ…å«å¯†æ–‡ï¼ˆciphertextï¼‰ä»¥åŠè®¤è¯æ ‡ç­¾ï¼ˆauthenticated tagï¼‰ï¼Œåœ¨çŸ¥é“<code>key</code>ä¸<code>iv</code>æ—¶å¯ä»¥ä½¿ç”¨<code>cipher.decrypt_and_verify</code>æ¥éªŒè¯å¯†æ–‡-æ ‡ç­¾å¯¹æ˜¯å¦æœ‰æ•ˆï¼Œè‹¥æœ‰æ•ˆåˆ™è¯¥å‡½æ•°è¿”å›è§£å¯†åçš„æ•°æ®ï¼Œå¦åˆ™æŠ›å‡ºé”™è¯¯ã€‚ä¸€æ¬¡è®¤è¯åŠ å¯†çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="center">
<img width="600" src="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/2.png" alt="Algorithm for the Authenticated Encryption Function (NIST)"></img>
<br><br>
<comment>Algorithm for the Authenticated Encryption Function (NIST)</comment>
</div>
<br>


<pre><code class="language-text">Encoding:

 b127  ||  b126  ||  ...  ||  b001  ||  b000    (MSB)
  ^         ^         ^        ^         ^
  |         |         |        |         |
  v         v         v        v         v
Î±^000  +  Î±^001  +   ...  +  Î±^126  +  Î±^127    (LSB)</code></pre>
<br>

<p>å¯¹äºæ¯128æ¯”ç‰¹ä½ä¸ºä¸€ç»„çš„æ•°æ®ï¼Œæˆ‘ä»¬å°†å…¶è½¬æ¢ä¸º\(\mathbb{F}_{2^{128}}=\mathbb{F}_2[\alpha]/(\alpha^{128}+\alpha^7+\alpha^2+\alpha+1)\)ä¸Šçš„å…ƒç´ ï¼Œå¹¶ä¸”<i>ä»å·¦å¾€å³çš„æ¯ä¸ªæ¯”ç‰¹ä½æŒ‰ç…§æ¬¡æ•°\(i\)ä»å°åˆ°å¤§çš„é¡ºåºæ”¾åœ¨\(\alpha^i\)çš„ç³»æ•°ä¸­ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰</i>ï¼Œä»¥æ­¤æ¥è¿›è¡Œåç»­çš„è®¡ç®—ï¼Œç”Ÿæˆæ ‡ç­¾\(T\)çš„æ ¸å¿ƒæµç¨‹ç›¸å½“äºï¼š</p>

<ul style="padding:">
<li>\( H=\text{AES}_K(0^{128}) \)</li>
<br>
<li>\( J_0=F_K(\text{IV}) \)</li>
<br>
<li>\( J=\text{AES}_K(J_0) \)</li>
<br>
<li>\( \text{GHASH}_H(X)=H\cdot X\in\mathbb{F}_{2^{128}}\qquad \text{with }X\text{ 128 bits}  \)</li>
<br>
<li>\( \text{GHASH}_H(X_1\Vert \cdots\Vert X_{n-1} \Vert X_n)=H\cdot X_n+H\cdot \text{GHASH}_H(X_1\Vert\cdots \Vert X_{n-1})\in\mathbb{F}_{2^{128}}\qquad \text{with }X_i\text{ 128 bits} \)</li>
<br>
<li>\( L=[\text{len}(A)]_{64}\Vert[\text{len}(C)]_{64} \)</li>
<br>
<li>\( S=\text{GHASH}_H(\underbrace{A\Vert 0^v}_{\text{128 bits}} \Vert \underbrace{C\Vert 0^u}_{128\cdot K\text{ bits}} \Vert L) \)</li>
<br>
<li>\( \begin{aligned}T&=\text{GCTR}_K(J_0,S)\\&=J+S\in\mathbb{F}_{2^{128}}\end{aligned} \)</li>
<br>
</ul>

<p>å…¶ä¸­\(\text{GCTR}\)å‡½æ•°çš„å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<div class="center">
<img width="600" src="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/3.png" alt="The GCTR function (NIST)"></img>
<br><br>
<comment>The GCTR function (NIST)</comment>
</div>
<br>

<p>è€Œ\(J_0=F_K(\text{IV})\)æ˜¯ä»…ä¸åˆå§‹åŒ–å‘é‡\(\text{IV}\)å’Œå¯†é’¥\(K\)æœ‰å…³çš„å‡½æ•°ï¼Œåœ¨æœ¬é¢˜ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„IVï¼Œæ¯”å¦‚</p>
\[
	\text{IV}=\underbrace{0000\cdots00}_{128}
\]

<p>æ¥ä¿è¯è®¤è¯åŠ å¯†ä»¥åŠè®¤è¯è§£å¯†è¿‡ç¨‹ä¸­\(J_0\)ä¸\(J\)æ˜¯ä¸å˜çš„ã€‚æˆ‘ä»¬ç”³è¯·ä¸¤ä¸ªå¯†æ–‡-æ ‡ç­¾å¯¹ï¼š</p>
\[
	(C_1,T_1),\ (C_2,T_2)
\]
\[
	\begin{aligned}
		C_1&=C_{11}\Vert C_{12}\\
		C_2&=C_{21}\Vert C_{22}\\
	\end{aligned}
\]

<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å¯†æ–‡çš„ç”Ÿæˆè¿‡ç¨‹</p>
\[C=\text{GCTR}_K(\text{inc}_{32}(J_0),P)\]

<p>è¿™ä¸€æ­¥ä¸­ï¼Œæ˜æ–‡\(P\)çš„ç¬¬ä¸€ä¸ªå—\(P_{11}\)æ¯æ¬¡éƒ½ä¼šä¸\(\text{AES}_K(\text{inc}_{32}(J_0))\)å¼‚æˆ–ï¼Œæ®æ­¤ï¼Œåœ¨çŸ¥é“è¿™ä¸ªæ˜æ–‡å—\(P_{11}\)ä¸å¯¹åº”å¯†æ–‡å—\(C_{11}\)çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ç¬¬ä¸€ä¸ªå—ä¸­å¯†æ–‡çš„å†…å®¹ï¼ˆäº‹å®ä¸Šåç»­çš„å—ä¹Ÿç±»ä¼¼åœ°å¯ä»¥ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªå¯¹åº”æ˜æ–‡ä¸º<code>admin\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b</code>çš„å¯†æ–‡å—\(C_3\)ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•ä¼ªé€ \(C_3\)çš„æ ‡ç­¾\(T_3\)ã€‚å°†\(T_1,T_2\)å±•å¼€ï¼š</p>
\[
	\begin{aligned}
		T_1 &= (((A\cdot H + C_{11})\cdot H + C_{12})\cdot H + L_1)\cdot H + J\\
		T_2 &= (((A\cdot H + C_{22})\cdot H + C_{22})\cdot H + L_2)\cdot H + J\\
	\end{aligned}
\]

<p>ä¹Ÿå³</p>
\[
	\begin{aligned}
		T_1 &= A\cdot H^4 + C_{11}\cdot H^3 + C_{12}\cdot H^2 + L_1\cdot H + J\\
		T_2 &= A\cdot H^4 + C_{21}\cdot H^3 + C_{22}\cdot H^2 + L_1\cdot H + J\\
	\end{aligned}
	\tag{1}\label{1}
\]

<p>åœ¨æœ¬é¢˜ä¸­ï¼Œå¯¹äº\(C_1,C_2,C_3\)è€Œè¨€ï¼Œæˆ‘ä»¬æœ‰</p>
<pre><code class="language-python">L1 = b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00'
L2 = b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00'
L3 = b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80'</code></pre>
<br>

<p>è€Œå¯¹äºé™„åŠ æ•°æ®\(A\)è€Œè¨€ï¼Œå‡æœ‰</p>
<pre><code class="language-python">A = b'\x00\x00\x00\x00\x00\x00\x00\x00'</code></pre>
<br>

<p>å°†\eqref{1}ä¸­ä¸¤å¼ç›¸åŠ ï¼š</p>
\[
	T_1+T_2 = (C_{11}+C_{21})\cdot H^3 + (C_{12}+C_{22})\cdot H^2
\]

<p>å› æ­¤ï¼Œ\(H\)æ˜¯\(\mathbb{F}_{2^{128}}\)ä¸Šå¦‚ä¸‹æ–¹ç¨‹çš„æ ¹ï¼š</p>
\[
	(C_{11}+C_{21})\cdot x^3 + (C_{12}+C_{22})\cdot x^2 + (T_1+T_2) = 0
\]

<p>äºæ˜¯ï¼Œ</p>
\[
	J = T_1 + A\cdot H^4 + C_{11}\cdot H^3 + C_{12}\cdot H^2 + L_1\cdot H
\]

<p>å› æ­¤æˆ‘ä»¬å¯ä»¥ä¼ªé€ å‡º\(T_3\)ï¼š</p>
\[
	T_3 = A\cdot H^3 + C_3\cdot H^2 + L_3\cdot H + J
\]

<p>å°†IVã€\(C_3\)ä¸\(T_3\)æ‹¼æ¥åœ¨ä¸€èµ·ä½œä¸ºtokenå‘é€å³å¯è·å¾—adminèº«ä»½ã€‚</p>
\[
	\text{tokenğŸ”’} = \text{IV}\Vert C_3\Vert T_3
\]

<p>ä¸Šè¿°æ”»å‡»æ–¹æ³•ç§°ä¸º<span style="color: red">The Forbidden Attack</span>ã€‚</p>

<pre><code class="language-python"># https://meowmeowxw.gitlab.io/ctf/utctf-2020-crypto/
# sage

from Crypto.Util.number import long_to_bytes as lb
from Crypto.Util.number import bytes_to_long as bl
from binascii import unhexlify, hexlify
from sage.all import *
import struct

def bytes_to_polynomial(block, a):
    poly = 0
    # pad to 128
    bin_block = bin(bl(block))[2 :].zfill(128)
    # reverse it to count correctly, wrong don't reverse it lol
    # bin_block = bin_block[::-1]
    for i in range(len(bin_block)):
        poly += a^i * int(bin_block[i])
    return poly

def polynomial_to_bytes(poly):
    return lb(int(bin(poly.integer_representation())[2:].zfill(128)[::-1], 2))

def convert_to_blocks(ciphertext):
    return [ciphertext[i:i + 16] for i in range(0 , len(ciphertext), 16)]

def xor(s1, s2):
    if(len(s1) == 1 and len(s1) == 1):
        return bytes([ord(s1) ^^ ord(s2)])
    else:
        return bytes(x ^^ y for x, y in zip(s1, s2))

F, a = GF(2^128, name="a", modulus=x^128 + x^7 + x^2 + x + 1).objgen()
R, x = PolynomialRing(F, name="x").objgen()

# Set correct values
C1 = convert_to_blocks(bytes.fromhex("ca6a3e623d125bdcddfe5c6e0ecba0911162c4f4469a62c32f1598ce9b161f92"))
T1 = bytes.fromhex("79be7f8880af8d18b8abac496fb690d2")
C2 = convert_to_blocks(bytes.fromhex("ca6a3e623d125bdcddfe5c6e0ecba0911162c4f5469a62c32f1598ce9b161f92"))
T2 = bytes.fromhex("abb63fd177e59f360ef2b3786e7fe4a9")
C3 = convert_to_blocks(bytes.fromhex("c5612754327d3dbeb8aa221660b2c5fb"))

L = struct.pack(">QQ", 0 * 8, len(C1) * 128)
C1_p = [bytes_to_polynomial(C1[i], a) for i in range(len(C1))]
C2_p = [bytes_to_polynomial(C2[i], a) for i in range(len(C2))]
C3_p = [bytes_to_polynomial(C3[i], a) for i in range(len(C3))]
T1_p = bytes_to_polynomial(T1, a)
T2_p = bytes_to_polynomial(T2, a)
L_p = bytes_to_polynomial(L, a)
L3 = struct.pack(">QQ", 0 * 8, len(C3) * 128)
L3_p = bytes_to_polynomial(L3, a)
# Here G_1 is already modified to include the tag
G_1 = (C1_p[0] * x^3) + (C1_p[1] * x^2) + (L_p * x) + T1_p
G_2 = (C2_p[0] * x^3) + (C2_p[1] * x^2) + (L_p * x) + T2_p
G_3 = (C3_p[0] * x^2) + (L3_p * x)
P = G_1 + G_2
auth_keys = [r for r, _ in P.roots()]
for H, _ in P.roots():
    EJ = G_1(H)
    T3 = G_3(H) + EJ
    print("H: " + str(H) + "\nT3: " + str(polynomial_to_bytes(T3).hex()))</code></pre>
<br>

<p>FlagğŸš©ï¼š</p>
<pre><code class="language-text" style="color: red">crew{priviledge_escalation_admin_by_crypto_technique}</code></pre>
<br>

<p>Proof of Conceptï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/sol_admin.sage">sol_admin.sage</a></li>
</ul>
<br><br>


<ul class="section"><li>
Reverse - HTML - 1
</li></ul>

<p>é™„ä»¶ï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/html.zip">html.zip</a></li>
</ul>
<br>

<p>æœ¬é¢˜æ˜¾ç„¶ä¸æ˜¯æ­£ç»çš„HTMLï¼ˆHyperText Markup Languageï¼‰ï¼Œäº‹å®ä¸Šï¼Œæ ¹æ®<a href="https://html-lang.org/" underlined>html-lang.org</a>çš„ä»‹ç»ï¼š</p>
<div class="center">
<img width="600" src="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/4.png" alt="HTML, The Programming Language (html-lang.org)"></img>
<br><br>
<comment>HTML, The Programming Language (html-lang.org)</comment>
</div>
<br>

<p>è¿™é‡Œçš„HTMLæŒ‡çš„æ˜¯ä¸€ç§é¢å‘å †æ ˆçš„ç¼–ç¨‹è¯­è¨€ï¼Œä»£ç ä¸­çš„æ¯ä¸€ç§æ ‡ç­¾éƒ½ä»£è¡¨äº†ä¸€ç§æ ˆæ“ä½œï¼ˆè¯¦è§<a href="https://html-lang.org/" underlined>html-lang.org</a>ï¼‰ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡åˆ™æ˜¯åˆ†æå‡ºè¿™ä¸ªç¨‹åºçš„é€»è¾‘ä»¥æ‰¾åˆ°åˆ¤æ–­å¯†ç æ˜¯å¦æ­£ç¡®çš„é€»è¾‘ã€‚é¦–å…ˆç¨‹åºåœ¨<code>&lt;main&gt;</code>ä¸­å®šä¹‰äº†å‡ ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li><code>l(c)</code>ï¼šç›¸å½“äº
<pre><code class="language-javascript">function l(c) {
    let e = document.createElement("p");
    let r = e;
    if (c) {
        r = c;
        e.appendChild(c);
        return r;
    }
    r = document.body.appendChild(e);
    return r;
}
</code></pre>
<p>æ‰€ä»¥åº”è¯¥æ²¡å•¥ç”¨ã€‚</p></li>
<li><code>w(a, b)</code>ï¼šç›¸å½“äºä¹˜æ–¹ - <code>pow(base, exp)</code></li>
<li><code>x(a, b)</code>ï¼šç›¸å½“äºå¼‚æˆ– - <code>xor(a, b)</code></li>
<li><code>m(a, b)</code>ï¼šç›¸å½“äºå–æ¨¡ - <code>mod(n, m)</code></li>
<li><code>r(z, o)</code>ï¼šç›¸å½“äºç‰¹æ®Šçš„RC4åŠ å¯†ï¼ˆè§£å¯†ï¼Ÿï¼‰ - <code>rc4(key, pt)</code></li>
<li><code>y()</code>ï¼šä¸<code>button#j</code>çš„<code>onclick</code>ç»‘å®šäº†ï¼ŒéªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®çš„é€»è¾‘å°±åœ¨è¿™ä¸ªå‡½æ•°ä¸­ã€‚</li>
</ul>

<p>Level 1ä¸­åªéœ€è¦çŸ¥é“è¿™ä¹ˆå¤šå°±å¤Ÿäº†ï¼Œæ¥ä¸‹æ¥é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯<code>y()</code>ä¸­éªŒè¯éƒ¨åˆ†çš„ä»£ç é‡ç•¥å¤§ï¼Œæˆ‘ä»¬å¯ä»¥<s>å°†ç¿»è¯‘è¿™éƒ¨åˆ†ä»£ç çš„å·¥ä½œäº¤ç»™äººå·¥ç»„æ¥å®Œæˆ</s>æŒ‰ç…§HTMLç¼–ç¨‹è¯­è¨€çš„é€»è¾‘ï¼Œç¼–å†™ä¸€ä¸ªä»¥å‹æ ˆä¸å¼¹æ ˆä¸ºåŸºç¡€çš„è§£é‡Šå™¨æ¥ç¿»è¯‘è¿™äº›ä»£ç ï¼Œå¹¶å°†é€”ä¸­ç”¨åˆ°çš„æ“ä½œä»¥è¡¨è¾¾å¼çš„å½¢å¼å‚¨å­˜ä¸‹æ¥ã€‚å®Œæˆäº†ç¿»è¯‘çš„å·¥ä½œä»¥åï¼Œç”±äºè¡¨è¾¾å¼æ˜¯æ¶‰åŠåˆ°åŠ æ³•ã€ä¹˜æ³•ä¸å¼‚æˆ–çš„ç­‰å¼æ–¹ç¨‹ç»„ï¼Œå› æ­¤äº¤ç”±<a href="https://github.com/Z3Prover/z3" underlined>Z3</a>æ¥å®Œæˆå³å¯ã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://beautifulsoup.readthedocs.io/zh-cn/v4.4.0/" underlined>BeautifulSoup</a>æå–å‡ºHTMLä»£ç ä¸­çš„æ ‡ç­¾ï¼Œéå†è¿™äº›æ ‡ç­¾å¹¶æŒ¨ä¸ªè§£æä¸ºå¯¹åº”çš„æ ˆæ“ä½œå³å¯ã€‚</p>
<br>

<pre><code class="language-python">html_doc =    # ...

from bs4 import BeautifulSoup
soup = BeautifulSoup(html_doc, 'html.parser')

queue = []
ops = []
stack = []

for child in soup.select("code > *"):
    if child.name == 'a':
        queue.extend(list(child.children))
    queue.append(child)

for child in queue:
    if child.name == 'data':
        ops.append('data %s' % child['value'])
    elif child.name == 'cite':
        assert child.text == 'p'
        ops.append('p')
    elif child.name == 'a':
        if child['href'] == 'javascript:x()':
            ops.append('xor')
        else:
            raise TypeError("Invalid function name: \"%s\"" % child['href'])
    elif child.name == 'address':
        ops.append('address')
    elif child.name == 'ul':
        ops.append('multiply')
    elif child.name == 'dd':
        ops.append('add')
    elif child.name == 'sub':
        ops.append('subtract')
    elif child.name == 'em':
        ops.append('equal')
    elif child.name == 'b':
        ops.append('and')
    else:
        raise TypeError("Invalid operation name: \"%s\"" % child.name)

ops = ops[::-1]
while ops:
    op = ops.pop()
    if op.startswith('data'):
        stack.append(int(op.split('data ')[1]))
    elif op == 'p':
        stack.append('p')
    elif op == 'xor':
        a = stack.pop()
        b = stack.pop()
        if 'p' in str(a) or 'p' in str(b):
            stack.append('(%s ^ %s)' % (b, a))
        else:
            stack.append(b ^ a)
    elif op == 'address':
        a = stack.pop()
        b = stack.pop()
        assert b == 'p'
        assert not 'p' in str(a)
        stack.append('p%s' % a)
    elif op == 'multiply':
        a = stack.pop()
        b = stack.pop()
        if 'p' in str(a) or 'p' in str(b):
            stack.append('(%s * %s)' % (b, a))
        else:
            stack.append(b * a)
    elif op == 'add':
        a = stack.pop()
        b = stack.pop()
        if 'p' in str(a) or 'p' in str(b):
            stack.append('(%s + %s)' % (b, a))
        else:
            stack.append(b + a)
    elif op == 'subtract':
        a = stack.pop()
        b = stack.pop()
        if 'p' in str(a) or 'p' in str(b):
            stack.append('(%s - %s)' % (b, a))
        else:
            stack.append(b - a)
    elif op == 'equal':
        a = stack.pop()
        b = stack.pop()
        if 'p' in str(a) or 'p' in str(b):
            stack.append('(%s == %s)' % (b, a))
        else:
            stack.append(int(b == a))
    elif op == 'and':
        a = stack.pop()
        b = stack.pop()
        if 'p' in str(a) or 'p' in str(b):
            #stack.append('(%s and %s)' % (b, a))
            stack.append('%s, %s' % (b, a))
        else:
            stack.append(int(bool(int(b) & int(a))))
    else:
        raise TypeError("Invalid operation name: \"%s\"" % child.name)

assert len(stack) == 1
expr = stack[0]
expr = f'[{expr}]'

from z3 import *

p0,p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15 = [BitVec(pp, 8) for pp in 'p0,p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15'.split(',')]
eqs = eval(expr)
s = Solver()
for eq in eqs:
    s.add(eq)
assert s.check() == sat
model = s.model()
print(bytes([int(str(model[pp])) for pp in [p0,p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15]]))</code></pre>
<br>

<p>PasswordğŸ”’ï¼š</p>
<pre><code class="language-text" style="color: red">pWnBHiIp6vfoK6Y8</code></pre>
<br>

<p>FlagğŸš©ï¼š</p>
<pre><code class="language-text" style="color: red">crew{w3lc0m3_t0_h7m1_3nj0y_th3_n3xt_l3v3l_9c6c1af9}</code></pre>
<br>

<p>Proof of Conceptï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/sol_html1.py">sol_html1.py</a></li>
</ul>
<br><br>

<ul class="section"><li>
<comment>(After Match)</comment> Pwn - Format muscle
</li></ul>

<p>é™„ä»¶ï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/format-muscle.zip">format-muscle.zip</a></li>
</ul>
<br>

<p>é¦–å…ˆmuslé‡Œçš„<code>printf</code>ä¸­ç”¨æ¥è¡¨ç¤ºåç§»çš„<code>$</code>æœ€å¤šåªèƒ½åç§»ä¹ä¸ª<code>QWORD</code>ï¼Œæ­¤å¤–ï¼Œåç§»æ•°å¿…é¡»å…¨éƒ¨åœ¨<code>1 ~ n</code>å†…ï¼Œä¸”<code>1 ~ n</code>å†…ä¸å…è®¸æœ‰æœªå‡ºç°çš„åç§»æ•°ï¼Œå…¶ä¸­<code>n</code>æ˜¯æŸä¸ªæ­£æ•´æ•°ã€‚å› æ­¤æˆ‘ä»¬åªèƒ½é€šè¿‡ä¸æ–­åœ°æ·»åŠ æ ‡è¯†ç¬¦æ¥äº§ç”Ÿåç§»ã€‚ï¼ˆå‚è§<comment>musl-1.2.2/src/stdio/vfprintf.cï¼Œ430~655</comment>ï¼‰</p>
<p>åœ¨æˆåŠŸåšåˆ°ä»»æ„åœ°å€å†™ä¹‹åï¼Œç¯¡æ”¹<code>exit</code>çš„hookå³å¯ã€‚</p>
<br>

<p>Proof of Conceptï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/exp_format-muscle.py">exp_format-muscle.py</a></li>
</ul>
<br><br>

<ul class="section"><li>
<comment>(Not Solved)</comment> Reverse - HTML - 2
</li></ul>

<p>é™„ä»¶ä¸HTML - 1æ˜¯ä¸€æ ·çš„ï¼Œæœ¬é¢˜ä¹Ÿæ˜¯é™„ä»¶ä¸­æ‰€è¯´çš„level 2ï¼Œç›¸æ¯”èµ·level 1æ¥æ–°å¢äº†æ›´å¤šçš„å‡½æ•°ä»¥åŠå˜é‡ï¼Œæ„Ÿè§‰åšæ³•åº”è¯¥æ˜¯å·®ä¸å¤šçš„ï¼Œæ‡’å¾—çœ‹äº†ğŸ˜´ğŸ’¤ã€‚</p>
<br><br>

<ul class="section"><li>
<comment>(Not Solved)</comment> Crypto - Bigger and better
</li></ul>

<p>é™„ä»¶ï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/bigger-and-better.zip">bigger-and-better.zip</a></li>
</ul>
<br>

<p><s>å¤šé¡¹å¼çš„ç³»æ•°éå¸¸åœ°åºå¤§ï¼Œå†è€…ï¼Œå„ç§ç”Ÿæˆéšæœºæ•°çš„å‡½æ•°éƒ½æœ‰ä¸ªå‰ç¼€<code>secrets</code>ï¼Œè®©äººå¾ˆéš¾ä¸è”æƒ³åˆ°è¿™å¯èƒ½æ˜¯ä¸€ä¸ªä¸PRNGæœ‰å…³çš„é—®é¢˜ï¼Œ</s>æ²¡è¯¦ç»†ç ”ç©¶äº†ğŸ˜´ğŸ’¤ã€‚</p>
<br><br>

<ul class="section"><li>
<comment>(Not Solved)</comment> Crypto - Noisy Encryption
</li></ul>

<p>é™„ä»¶ï¼š</p>
<ul>
	<li><a underlined href="/tales-of-the-martyrs/tales/oracle-of-namagiri/8/noisy-encryption.zip">noisy-encryption.zip</a></li>
</ul>
<br>

<p>è¿™ä¸ªè‚¯å®šæ˜¯PRNGçš„é—®é¢˜ï¼Œä½†æ˜¯æ²¡æœ‰è¯¦ç»†ç ”ç©¶ğŸ˜´ğŸ’¤ã€‚</p>
<br><br>



</div>
<br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br><p style="color:gray">Tags: <span style="color:blue"><b>#CrewCTF</b></span><span color="gray">, </span><span style="color:blue"><b>#Cryptography</b></span><span color="gray">, </span><span style="color:blue"><b>#ReverseEngineering</b></span><span color="gray">, </span><span style="color:blue"><b>#LatticeBasedCryptography</b></span><span color="gray">, </span><span style="color:blue"><b>#LinearCongruentialGenerator</b></span><span color="gray">, </span><span style="color:blue"><b>#StreamCipher</b></span><span color="gray">, </span><span style="color:blue"><b>#AES-GCM</b></span><span color="gray">, </span><span style="color:blue"><b>#HTML-TheProgrammingLanguage</b></span></p>
                    <p><div class="time"></div><span style="color:gray">Time: </span><b>2024-08-05 14:23</b></p><br><br><br><br><br><br>
	<script type="text/javascript" src="/essence-of-the-elders/spirit-of-mathematics/MathJax.js?config=TeX-AMS_HTML" async></script>
	<script type="text/x-mathjax-config;executed=true">
        window.MathJax.Hub.Config({
            showProcessingMessages: false,
            messageStyle: "none",
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]],
                displayMath: [["$$", "$$"], ["\\[", "\\]"]],
                skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"]
            },
            "HTML-CSS": {
                availableFonts: ["STIX", "TeX"],
                showMathMenu: false
            },
			SVG: { linebreaks: {automatic: true } }
        });
        //window.MathJax.Hub.Queue(["Typeset", MathJax.Hub,document.getElementsByClassName("ck-content")]);
	</script>
	<script src="/essence-of-the-elders/spirit-of-codes/prism.js"></script>
</body>
</html>