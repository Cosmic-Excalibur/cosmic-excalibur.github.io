from Crypto.Util.number import *
import itertools

C = [613865483278018068252699664344014709603516906746931166051427750616361200468707690831404020218656875084418550224413996053079342864898401795763165162078246618111604777593040660642912057306221452064472274046070821517539193613498685453074624282109324379926231192557180542435340969864132119593041711358872115405874364598887793241511430254996199731357082354916052164113949623179598136562096295676073087781639871668219434230021548949701211884517843541157354088095790525632350783639986022007948401580816197207016436522842590665610501156024865695696904566492693695119723293496114231169856305023037844584473338807912586875707600364819890669100254969485468659519811774306439412606664839186477469471705259250833176668759144364716469013187497055958568568833468917267690747466509873300681042926144801047098106011988640738905375480014330337236157762241463040450369329857116881974521230050992365545267271071656913911801116050540398641643774385253106721071704372814783224265146831781292451519671545831104249259649825043436077261829424199640586840100064504718504084687245230247025590555140567918382183739553868767104267287390814588272528022263596870309219008420027857207262298920988240843464367423459125938409345791905262506077210767697641725131845657915063006168678036973128294138919177816631075260964754920461338919640208715147859313022129119104220613492278409206331300978073447313353841266579693269593051798634892554731378288693431694643916314688532279216322727915161656058481514673086014058447608248813383574448881880352040004076733393319193468994104200546510770868505329993104192562433855428535979312784724513183099390633645671120844556506294295992655282194352892131753495674679615743981810959623439744331909310673221108784996807299072882654656204672704933960205980110750900159183959219642112579212752633053366765488410011288671891300805386272118441610217334300094529853561081688887902830562014461520447717503298663406799238245231377946213086275128298967334260627923676793074685734652984469626476959708684429179459632962489958308714628030000000000000000000,
 245036407881857959287329830175942706463416768027824429948879346277422003699457014126016471953549050974511782570985406068015653856751073181204606508880472740897864432220323705625937723592407228308614715490060058709069016568567438734565962590473673005675759085272303663852924409195629642983178122328001025761494958094134279528106341931867819226142142680177094828455727710782203907942318927635124916532186362671128525242786141457827381259621223108069463687125827994454790018748401702097150047312769880492739552908908395881610091036141344796838225584613111341931562918065397742880155922130129441146777911073347040480502480677909610449766356096451134660548394769165869714551812875631168335378756798728524265965000459160845906788524532136037474116210092445785845743216069672883155073507894993602107679715605044764911670210565757732039136742064129286837296471827518657626721063625117925168602633447005906713160137988996261251501680337755779359894915441893301513493772480714167765671109158678948410039887159632132823015397725480192030546043246576825850869748832939936933646214777654242534866208464171219146270696521793237476380532948084789468416848423911243706750909219565584569874389623611016474234739322155950295663028911924382021031665316058903633523810110153294750028019337727774946251898525260055264094894155634703566981191773697842453670906170168327257032454552103439719814832847426662260759847646820290241944120935874699738656232648258878387184076654484513275386410355834148350422801865248714301748448591993714183653301791561430492386555964749612179649066353090209829670980882798717726213549350941651041482778513086755284017238298725893240516990542758781336061654914298113867405663849760195871720152960766958778476701823353536215291865386406184712305381587593355548946820269731998605638237460524132123304961069074555779915321922449145487924853715079737700445005331793919111487168370490046749815723253746697194647632724486411962784448518088389594250531745922561790398386115775544107851726855067767471094564187060544072353093410000000000000000000,
 137345167246666152708695783992412451677215580505686234812951963763679752421305551022015155803163309666971488904115342219232259529052858971830109224061750942620692080747392750978055361856345609826176488327805756580210595022999363668000469758252248327149080105197638338303484216555091688813588555333510441403631924361427636264564046523835923765469527935139679379386365438107231455649479487805731169749085267746059559514699431878656445965241391074816533866819502401015206929538768066200844230383673885609058718758365307394041843037427182624181178057180361223570519287165962763997628496291074953228826757194090510732990896951243932788369410132727897854779531315157608625947438329174042524724317329124344803552507615463264253345892309311091339661126987056310642985406296440871743394954512334151657842081548626329947469991005060808522912402314660758076891379824067812893861092431953843994445173216544494475407875411276857943687756116627236016855451446359534079264141929818173259254671231868234537006106743388133752199590420082019608574059882224317624490686155657705921613800299255280046339254117499032725128058967583503760287590940751637595412529962186479629217376952256070006728273557123194848341390820063238711207834738915993003158295571381417446165223219814817626186658220024968670843812228276336596273600220433933868193204886478934581221324262436532698273968641099125685700756114607930166822142808608245552575350366696131994455164977252273496491154604306287898516787860538324884697049752906390376236662387755084755036152482561426873258105894241708212377022344725839909078529834280720247713295473287700351455795133037704698727585053725158008602361592295937700172703833011429932649829034737378725327895789993587018237431176760456411594673158970559243996329985790241951949068041568206217487475151757829081387728287760419037505904183327317706932146021151723156372793138559364784437546768044168087774329609767630347169983600168183638264489185297458737897176049910195052200785459413965113311423240378417201396789858902985778303513310000000000000000000,
 248598813941244564314190366976956238846212871541771930109739106055807792612103659841747497961804199239312115138739615717522312384591346952231040832769615694520183929820793243171365352064522618818268734146026295944717076601574578962149885913986264917072612648406944008780161718484891653216331603067660223327065082133281193527061702732629312805614238511783357097265059355229182722644804518989811785174512014831515915540086579606923453504558913653215939402754608902953067382824050713812988957831717406038323088677784487857111181278250211802531823885151511581560283519938318700855349756341888256978768135799142228025521565945660152285288273978507946361855975677901997508130633569176262919271095976286058965644154047854752559078430905002843715781168095058060892858505032895232749576897035572266508191887532558875802944039192330206710570764850449524338167719653856734947117714741264286519801196041195595625961887148627775449193551562322436527185177095282032622053584429412808153881989877436286895160054446636136680470078861229315711399307846886400459965825709625547139674054067620019060633783021254018981555506034898141353911374301860590413844969222399987475873033661474210380913697225102048047343957805720068156153501151113672221105170896891889741086539020293760565513979000196534198843807780426608172044854707495713399829270390797344830800439345637573264849501828112300315593463854572982408501541789519007391783535642352163222327917003694861125256071721797829146906100123233497467252973410697641275412187628933675567544293121363459434834942362036597044642264889315654382627597888721142087838187921210798403660021133166540634509196864046647672264461161871971071565554348244851718639558956567101144942859155048503821998325643228008503874230972127046706566989692499452699745710513951095646723547726547445856840533797535991543699148183721196378298945161957380138935154762667738029293610652381093050194682857630723332290801555104595724043212397883742835071072687534079762780204306291507876787903000016232596458969200377950937939150020000000000000000000]
 
A = matrix(ZZ, 4, 5)

for i in range(4):
    A[i,0] = C[i]
    A[i,i+1] = 1

A_ = A.LLL()
v = A_[0]
a = v[1:]

B = matrix(ZZ, 4, 5)

for i in range(4):
    B[i,0] = a[i]*2**128
    B[i,i+1] = 1

B_ = B.LLL()

D = B_[:-1,1:]
center = 2**63#(2**63+(2**64-2**63)//2)
t = vector([center]*4)

def kannan_cvp(mat, target, reduction=(lambda x: x.LLL()), weight=None):
    """
    Solve closest vector problem using Kannan's algorithm

    :param mat: a matrix
    :param target: a vector
    :returns: a solution as a vector
    """
    if weight is None:
        weight = max(target)
    L = block_matrix([[mat, 0], [-matrix(target), weight]])
    for row in reduction(L):
        if row[-1] < 0:
            row = -row
        if row[-1] == weight:
            return row[:-1] + target

tt = kannan_cvp(D, t)
print(tt)

cand1 = (12792141052963846634, 9046310731417797269, 9252493367855630333, 7146501603640644696)
cand2 = (5399616291323082697, 9758841818404885789, 7935165959465319733, 13234149580902310257)
cand3 = (3359842739501408499, 8891228064188007892, 12225198018622121366, 6127037753097347812)
cand4 = (6728221938201536857, 2777926548143569583, 3523273592081980311, 352951208792993045)
cand5 = (12127838229524619554, 12536768366548455372, 11458439551547300044, 13587100789695303302)
cand6 = (6063919114762309777, 6268384183274227686, 5729219775773650022, 6793550394847651651)
cand7 = (8103692666583983975, 7135997937491105583, 1439187716616848389, 13900662222652614096)
cand8 = (13456443876403073714, 5555853096287139166, 7046547184163960622, 705902417585986090)
cand9 = (2695539916062181419, 12381685699318665995, 14431144202313791077, 12567636939152006418)
cand10 = (16160520251663974992, 2933009215373358960, 550568941315489278, 1372415059336289929)
cand11 = (15496217428224747912, 6423466850504017063, 2756515125007158989, 7813014245390948535)
cand12 = (10752367501142172436, 8178696977200919372, 13542525427012431966, 39389775835682251)

test = lambda *arr: list(long_to_bytes(a[0]^^b[0]^^c[0]) for a,b,c in itertools.combinations(arr, 3))
candidates = [eval('cand%d'%i) for i in range(1, 12 + 1)]
for cand in candidates:
    assert all(x > 0 and x < 2**64 for x in cand)
    assert vector(cand)*a == 0
res = test(*candidates)
for entry in res:
    if all(32 <= x <= 127 for x in entry) or b'corctf' in entry:
        print('\x1b[32;1m%s\x1b[0m        <-  Gotcha ;)' % str(entry))
    else:
        print(str(entry))